name: Deploy to Google Cloud Run by Terraform

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: ${{ vars.GCP_REGION }}
  TF_BACKEND_BUCKET: ${{ vars.TF_BACKEND_BUCKET }}
  TF_WORKSPACE: ${{ vars.TF_WORKSPACE }}
  GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}

jobs:
  deploy-by-terraform:
    name: Deploy C++ API to Cloud Run
    runs-on: ubuntu-latest
    environment: gcp-kototech-dev
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_wrapper: false

    - name: Terraform Init
      run: |
        cd terraform/gcp
        terraform init -backend-config="bucket=$TF_BACKEND_BUCKET"

    - name: Terraform Plan
      run: |
        cd terraform/gcp
        terraform plan

    - name: Terraform Apply
      run: |
        cd terraform/gcp
        terraform apply -auto-approve

    - name: Get URL
      id: get-api-url
      run: |
        cd terraform/gcp
        API_URL=$(terraform output -raw cpp_api_service_url)
        FRONTEND_URL=$(terraform output -raw frontend_service_url)
        echo "API_URL=$API_URL" >> $GITHUB_OUTPUT
        echo "API deployed at: $API_URL"
        echo "Health check: $API_URL/health"
        echo "Metrics: $API_URL/metrics"
        echo "API endpoint: $API_URL/api/shops"
        echo "FRONTEND_URL=$FRONTEND_URL" >> $GITHUB_OUTPUT

    outputs:
      api_url: ${{ steps.get-api-url.outputs.API_URL }}
      frontend_url: ${{ steps.get-api-url.outputs.FRONTEND_URL }}


