import { useState, useEffect, useRef } from 'react';
import './App.css';
import LeafletMap from './components/LeafletMap';
import ShopCard from './components/ShopCard';
import UserRegistrationForm from './components/UserRegistrationForm';
import SearchBar from './components/SearchBar';
import UserProfileCard from './components/UserProfileCard';
import useGeolocation from './hooks/useGeolocation';
import { CurryShop, UserRegistration, PublicUser, User } from './types';

function App() {
  const [shops, setShops] = useState<CurryShop[]>([]);
  const [selectedShop, setSelectedShop] = useState<CurryShop | null>(null);
  const [loading, setLoading] = useState(true);
  // Use the custom geolocation hook
  const { location: userLocation, refreshLocation, error: locationError, isLoading: locationLoading } = useGeolocation({
    enableHighAccuracy: true,
    timeout: 10000,
    maximumAge: 60000, // 1åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    watchPosition: true,
    distanceThreshold: 10, // 10mç§»å‹•ã—ãŸã‚‰æ›´æ–°
    updateInterval: 30000, // 30ç§’é–“éš”ã§æœ€å¤§ãƒã‚§ãƒƒã‚¯
  });

  // Debug: Log location status
  useEffect(() => {
    console.log('ğŸ—ºï¸ App.tsx: Location status changed', {
      userLocation,
      locationError,
      locationLoading
    });
  }, [userLocation, locationError, locationLoading]);
  const shopListRef = useRef<HTMLDivElement>(null);
  
  // User management state
  const [currentUser, setCurrentUser] = useState<User | null>(null);
  const [users, setUsers] = useState<PublicUser[]>([]);
  const [selectedUser, setSelectedUser] = useState<PublicUser | null>(null);
  const [showUserRegistration, setShowUserRegistration] = useState(false);
  const [showUserProfiles, setShowUserProfiles] = useState(false);
  const [registrationLoading, setRegistrationLoading] = useState(false);
  
  // Search state
  const [searchQuery, setSearchQuery] = useState('');

  const fetchShops = async (search = '', userId = '') => {
    try {
      const params = new URLSearchParams();
      if (search) params.append('search', search);
      if (userId) params.append('userId', userId);
      
      const response = await fetch(`http://localhost:8000/api/shops?${params}`);
      const data = await response.json();
      setShops(data);
    } catch (error) {
      console.error('Error fetching shops:', error);
      setShops([
        {
          id: '1',
          name: 'è©è–©å’–å–±',
          address: 'å¥ˆè‰¯çœŒå¥ˆè‰¯å¸‚è–¬å¸«å ‚ç”º21',
          latitude: 34.6775,
          longitude: 135.8328,
          spiceParameters: {
            spiciness: 60,
            stimulation: 45,
            aroma: 85
          },
          rating: 4.6,
          description: 'å¥ˆè‰¯å¸‚åˆã®ãƒ€ãƒ«ãƒãƒ¼ãƒˆå°‚é–€åº—ã€‚å¾¡éœŠç¥ç¤¾ã™ãæ±ã®å¤æ°‘å®¶ã§é‡èœãŸã£ã·ã‚Šã®ã‚¹ãƒ‘ã‚¤ã‚¹ã‚«ãƒ¬ãƒ¼ã‚’æä¾›'
        },
        {
          id: '2',
          name: 'ãƒãƒãƒã‚¹',
          address: 'å¥ˆè‰¯çœŒå¥ˆè‰¯å¸‚å—å¸‚ç”º8-1 å¤å¤å¤å±‹1éš',
          latitude: 34.6755,
          longitude: 135.8312,
          spiceParameters: {
            spiciness: 70,
            stimulation: 75,
            aroma: 80
          },
          rating: 4.4,
          description: 'ãªã‚‰ã¾ã¡ã®è–¬è†³ã‚¹ãƒ‘ã‚¤ã‚¹ã‚¹ãƒ¼ãƒ—ã‚«ãƒ¬ãƒ¼ã¨èœ‚èœœã®åº—ã€‚èº«ä½“ã«å„ªã—ã„ã‚¹ãƒ‘ã‚¤ã‚¹ä½¿ã„ãŒè©•åˆ¤'
        },
        {
          id: '3',
          name: 'è‹¥è‰ã‚«ãƒ¬ãƒ¼æœ¬èˆ—',
          address: 'å¥ˆè‰¯çœŒå¥ˆè‰¯å¸‚é¤…é£¯æ®¿ç”º38-1',
          latitude: 34.6851,
          longitude: 135.8050,
          spiceParameters: {
            spiciness: 55,
            stimulation: 50,
            aroma: 75
          },
          rating: 4.2,
          description: 'è¿‘é‰„å¥ˆè‰¯é§…ã‹ã‚‰å¾’æ­©3åˆ†ã®ã‚‚ã¡ã„ã©ã®ã‚»ãƒ³ã‚¿ãƒ¼è¡—ã«ã‚ã‚‹äººæ°—ã®ã‚«ãƒ¬ãƒ¼åº—ã€‚ã»ã†ã‚Œã‚“è‰ã‚„ãƒˆãƒãƒˆãªã©é‡èœãŸã£ã·ã‚Šã®ãƒ˜ãƒ«ã‚·ãƒ¼ãªã‚«ãƒ¬ãƒ¼ãŒè‡ªæ…¢'
        }
      ]);
    } finally {
      setLoading(false);
    }
  };


  const fetchUsers = async () => {
    try {
      const response = await fetch('http://localhost:8000/api/users');
      const data = await response.json();
      setUsers(data);
    } catch (error) {
      console.error('Error fetching users:', error);
    }
  };

  useEffect(() => {
    fetchShops();
    fetchUsers();
  }, []);

  const handleShopSelect = (shop: CurryShop) => {
    setSelectedShop(shop);
    
    setTimeout(() => {
      const shopElement = document.getElementById(`shop-${shop.id}`);
      if (shopElement && shopListRef.current) {
        shopElement.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'center',
          inline: 'nearest'
        });
      }
    }, 100);
  };


  const handleSearch = (query: string) => {
    setSearchQuery(query);
    if (query.trim()) {
      fetchShops(query.trim(), currentUser?.id);
    } else {
      fetchShops('', currentUser?.id);
    }
  };

  const handleUserRegistration = async (userData: UserRegistration) => {
    setRegistrationLoading(true);
    try {
      const response = await fetch('http://localhost:8000/api/users/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(userData),
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Registration failed');
      }
      
      const newUser = await response.json();
      setCurrentUser({ ...userData, id: newUser.id, username: userData.username, email: userData.email, isPublic: true, createdAt: newUser.createdAt });
      setShowUserRegistration(false);
      
      const usersResponse = await fetch('http://localhost:8000/api/users');
      const usersData = await usersResponse.json();
      setUsers(usersData);
      
      fetchShops(searchQuery, newUser.id);
      
      alert('ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼ã‚ãªãŸã®å¥½ã¿ã«åˆã£ãŸãŠåº—ãŒä¸Šä½ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚');
    } catch (error) {
      console.error('Registration error:', error);
      alert(error instanceof Error ? error.message : 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    } finally {
      setRegistrationLoading(false);
    }
  };

  const handleUserSelect = (user: PublicUser) => {
    setSelectedUser(user);
    fetchShops(searchQuery, user.id);
  };

  const clearUserFilter = () => {
    setSelectedUser(null);
    fetchShops(searchQuery, '');
  };

  if (loading) {
    return (
      <div 
        style={{ 
          display: 'flex', 
          justifyContent: 'center', 
          alignItems: 'center', 
          height: '100vh',
          backgroundColor: 'rgba(255, 248, 237, 0.95)',
          color: '#2d1810',
          fontSize: '18px',
          fontWeight: '600'
        }}
      >
        ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
      </div>
    );
  }

  return (
    <div 
      style={{ 
        padding: 'clamp(16px, 4vw, 24px)', 
        fontFamily: 'Noto Sans JP, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif', 
        background: 'linear-gradient(135deg, #faf7f2 0%, #f5f1ea 50%, #ede4d3 100%)',
        minHeight: '100vh',
        color: '#2d1810'
      }}
    >
      <header 
        style={{ 
          textAlign: 'center', 
          marginBottom: '32px',
          borderBottom: '2px solid rgba(184, 128, 87, 0.4)',
          paddingBottom: '24px'
        }}
      >
        <div style={{ 
          display: 'flex', 
          justifyContent: 'space-between', 
          alignItems: 'center', 
          marginBottom: '16px',
          flexWrap: 'wrap',
          gap: '16px'
        }}>
          <h1 
            style={{ 
              color: '#8b4513', 
              fontSize: 'clamp(24px, 5vw, 36px)', 
              margin: '0', 
              fontWeight: '900',
              lineHeight: '1.1',
              textShadow: '2px 2px 4px rgba(45, 24, 16, 0.3)',
              letterSpacing: '-0.5px',
              flexShrink: 0
            }}
          >
            ã‚¹ãƒ‘ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ‰Nara
          </h1>
          
          <div style={{ 
            display: 'flex', 
            gap: '8px', 
            alignItems: 'center',
            flexWrap: 'wrap',
            justifyContent: window.innerWidth <= 768 ? 'center' : 'flex-end'
          }}>
            {currentUser ? (
              <>
                <div style={{
                  padding: '8px 16px',
                  backgroundColor: 'rgba(210, 105, 30, 0.1)',
                  borderRadius: '12px',
                  border: '2px solid rgba(210, 105, 30, 0.3)',
                  color: '#8b4513',
                  fontSize: '14px',
                  fontWeight: '700'
                }}>
                  ãƒ­ã‚°ã‚¤ãƒ³ä¸­: {currentUser.displayName}
                </div>
                <button
                  onClick={clearUserFilter}
                  style={{
                    padding: '8px 16px',
                    border: '2px solid rgba(184, 128, 87, 0.6)',
                    borderRadius: '12px',
                    backgroundColor: 'transparent',
                    color: '#8b4513',
                    fontSize: '14px',
                    fontWeight: '700',
                    cursor: 'pointer'
                  }}
                >
                  ãƒ•ã‚£ãƒ«ã‚¿ã‚¯ãƒªã‚¢
                </button>
              </>
            ) : (
              <button
                onClick={() => setShowUserRegistration(true)}
                style={{
                  padding: '8px 16px',
                  border: 'none',
                  borderRadius: '12px',
                  backgroundColor: '#d2691e',
                  color: '#ffffff',
                  fontSize: '14px',
                  fontWeight: '700',
                  cursor: 'pointer',
                  boxShadow: '0 2px 4px rgba(210, 105, 30, 0.3)'
                }}
              >
                ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
              </button>
            )}
            <button
              onClick={() => setShowUserProfiles(!showUserProfiles)}
              style={{
                padding: '8px 16px',
                border: '2px solid rgba(184, 128, 87, 0.6)',
                borderRadius: '12px',
                backgroundColor: showUserProfiles ? 'rgba(184, 128, 87, 0.1)' : 'transparent',
                color: '#8b4513',
                fontSize: '14px',
                fontWeight: '700',
                cursor: 'pointer'
              }}
            >
              {showUserProfiles ? 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’é–‰ã˜ã‚‹' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«'}
            </button>
          </div>
        </div>

        <div style={{ 
          display: 'flex', 
          alignItems: 'center', 
          justifyContent: 'center', 
          gap: 'clamp(16px, 4vw, 24px)', 
          marginBottom: '24px',
          flexDirection: window.innerWidth <= 768 ? 'column' : 'row',
          textAlign: window.innerWidth <= 768 ? 'center' : 'left'
        }}>
          <img 
            src="/spice-deer.webp" 
            alt="Spice Your Nara" 
            style={{ 
              width: 'clamp(80px, 15vw, 120px)', 
              height: 'clamp(80px, 15vw, 120px)', 
              borderRadius: '16px',
              boxShadow: '0 8px 20px rgba(139, 69, 19, 0.3)',
              border: '3px solid rgba(210, 105, 30, 0.4)'
            }} 
          />
          <p 
            style={{ 
              color: '#5a3429', 
              fontSize: 'clamp(14px, 3vw, 18px)', 
              fontWeight: '600',
              margin: '0',
              lineHeight: '1.6',
              maxWidth: window.innerWidth <= 768 ? 'none' : '300px'
            }}
          >
            å¤šæ¬¡å…ƒã‚¹ãƒ‘ã‚¤ã‚¹åˆ†æã«ã‚ˆã‚‹è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ 
          </p>
        </div>

        <div style={{ maxWidth: '600px', margin: '0 auto' }}>
          <SearchBar
            onSearch={handleSearch}
            placeholder="åº—åã€ä½æ‰€ã€ç‰¹å¾´ã§æ¤œç´¢..."
            initialValue={searchQuery}
          />
          {(selectedUser || currentUser) && (
            <div style={{
              textAlign: 'center',
              fontSize: '14px',
              color: '#8b4513',
              fontWeight: '600',
              marginTop: '8px'
            }}>
              {selectedUser ? `${selectedUser.displayName}ã•ã‚“ã®å¥½ã¿ã§ã‚½ãƒ¼ãƒˆä¸­` : 'å¥½ã¿ã«åˆã‚ã›ã¦ã‚½ãƒ¼ãƒˆä¸­'}
              {shops.length > 0 && shops[0].matchScore && (
                <span style={{ marginLeft: '8px', opacity: 0.8 }}>
                  (æœ€é«˜ãƒãƒƒãƒåº¦: {shops[0].matchScore}%)
                </span>
              )}
            </div>
          )}
        </div>

        {showUserProfiles && (
          <div style={{
            marginTop: '24px',
            maxWidth: '800px',
            margin: '24px auto 0'
          }}>
            <h3 style={{
              color: '#8b4513',
              fontSize: '20px',
              fontWeight: '800',
              marginBottom: '16px',
              textAlign: 'center'
            }}>
              ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
            </h3>
            <div style={{
              display: 'grid',
              gap: '16px',
              maxHeight: '400px',
              overflowY: 'auto',
              padding: '8px'
            }}>
              {users.map(user => (
                <UserProfileCard
                  key={user.id}
                  user={user}
                  onClick={() => handleUserSelect(user)}
                  isSelected={selectedUser?.id === user.id}
                />
              ))}
            </div>
          </div>
        )}
      </header>

      <main>
        <div 
          style={{ 
            display: 'grid', 
            gridTemplateColumns: window.innerWidth <= 1024 ? '1fr' : '1fr 480px', 
            gap: 'clamp(20px, 5vw, 40px)', 
            maxWidth: '1400px', 
            margin: '0 auto'
          }}
        >
          <section>
            <h2 
              style={{ 
                color: '#8b4513', 
                marginBottom: '24px', 
                fontSize: '24px', 
                fontWeight: '800',
                borderLeft: '6px solid #d2691e',
                paddingLeft: '20px',
                background: 'rgba(210, 105, 30, 0.15)',
                padding: '16px 20px',
                borderRadius: '12px'
              }}
            >
              åº—èˆ—ä½ç½®ãƒãƒƒãƒ—
            </h2>
            <div 
              style={{ 
                backgroundColor: 'rgba(255, 248, 237, 0.8)', 
                border: '2px solid rgba(184, 128, 87, 0.4)', 
                borderRadius: '16px', 
                padding: '20px'
              }}
            >
              <LeafletMap 
                shops={shops} 
                onShopSelect={handleShopSelect}
                selectedShop={selectedShop}
                userLocation={userLocation}
                onCenterOnLocation={refreshLocation}
              />
            </div>
          </section>
          
          <section>
            <h2 
              style={{ 
                color: '#8b4513', 
                marginBottom: '24px', 
                fontSize: '24px', 
                fontWeight: '800',
                borderLeft: '6px solid #d2691e',
                paddingLeft: '20px',
                background: 'rgba(210, 105, 30, 0.15)',
                padding: '16px 20px',
                borderRadius: '12px'
              }}
            >
              åº—èˆ—è©³ç´°æƒ…å ±
            </h2>
            <div 
              ref={shopListRef}
              style={{ 
                maxHeight: '600px', 
                overflowY: 'auto', 
                paddingRight: '8px'
              }}
            >
              {shops.map(shop => (
                <div key={shop.id} id={`shop-${shop.id}`}>
                  <ShopCard
                    shop={shop}
                    onClick={() => handleShopSelect(shop)}
                    isSelected={selectedShop?.id === shop.id}
                  />
                </div>
              ))}
            </div>
          </section>
        </div>
      </main>

      {showUserRegistration && (
        <UserRegistrationForm
          onRegister={handleUserRegistration}
          onCancel={() => setShowUserRegistration(false)}
          isLoading={registrationLoading}
        />
      )}
    </div>
  );
}

export default App;